# 设计思路(Event sourcing + virtual dom algo + bigpipe/pjax)

## 前沿

自从在XX公司面试失败之后，每天工作时我都不禁的想一个问题，如何把技术发挥到极致，如何把项目做的极致。因为面试时他们常问我一类问题，大概是让我描述一件工作中记忆深刻的事情。我没有好的答案，现在才发现我做的工作都很平庸，没有什么亮点。

于是我决定做出点成绩！机会来了！

## 业务场景

我不能详细的全盘托出我现在做的东西，毕竟涉及商业机密。但是我可以抽象一点的说这个是。

想象我们需要对外提供类似于图片压缩或者视频转码的服务，启动这项服务需要填写很多的配置信息，比如端口号，主机名称，最大进程数，日志目录，还包括连接的数据库配置信息，比如数据库主机地址，数据库端口号，数据库账号密码。而且线上环境、测试环境、staging环境的配置各不相同。原来的操作是人工的去修改配置文件，这样是有风险的（比如修改错了，影响到了其他参数，或者忘记修改了某个参数，或者无法启动也不知道错误在哪）。于是我们决定把这项工作可视化，通过UI界面去完成操作，而不是直接修改配置文件。

所以你可以想象，UI界面一定是一个冗长的表单。传统的前端技术手段是，当用户修改完某些字段数据点击保存之后，提交整张表单到服务端，然后服务端再返回额外的信息。在这个业务场景中，返回的仍然是配置表单，但是会多一些附加信息，比如提示服务是否启动成功，高亮格式不正确的字段（例如IP地址格式问题）

## 问题

问题在于上面描述的最后一个步骤。我们假设表单有10个配置需要填写，而用户只修改了一个字段，则整个表达的数据都要上传。这样的效率会不会太低？进一步说，我们是否能只上传修改的字段？同理，如果服务端在返回数据时，只返回被修改了的信息，这样我们也能针对性的修改DOM以提高渲染效率。

综上，我们有以下问题需要解决：

- 如何找到被修改数据字段？因为我们的数据是以Object的形式存储，所以这涉及到Object diff的算法问题
- 即便找到了被修改的字段，我们怎么告诉服务端这个字段发生了修改？换句话说，我们以什么样的数据结构组织修改的数据并且回传
- 当我们接收到服务端返回的数据后，我们如何把它翻译成修改的数据，并且找到对应的DOM进行修改？

总而言之，我们的目标是，最少的信息交换，最少的页面修改，最高的执行效率。最后，我们会再次搭建一个传统的表单页面来对比效率究竟提升了多少

## 关于Object的diff问题

